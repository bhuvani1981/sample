 - name: promoteBuildArtifact | Initialize or update git repo
   ansible.builtin.shell: |
        if [ ! -d .git ]; then
          git init
        fi
        git remote -v | grep -q origin || git remote add origin {{ destination_repo }}
        git fetch origin
        git checkout -f $(git rev-parse --verify origin/master 2>/dev/null || git rev-parse --verify origin/main 2>/dev/null || echo "HEAD")
        git branch -D {{ target_branch }} 2>/dev/null || true
        git checkout -b {{ target_branch }} 2>/dev/null || git checkout {{ target_branch }}
        git fetch --tags
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}"
      tags: [skip_ansible_lint]

    - name: promoteBuildArtifact | Get existing tags
      ansible.builtin.command: git tag
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}/"
      register: git_tags


    - name: promoteBuildArtifact | Set candidate number and tags
      ansible.builtin.shell: |
        candidate_tags=$(echo "{{ git_tags.stdout }}" | grep "{{ tag_name }}_candidate" | sort -V)
        if [ -z "$candidate_tags" ]; then
          echo "1"
        else
          last_num=$(echo "$candidate_tags" | tail -1 | sed -E 's/.*_candidate([0-9]+)$/\1/')
          echo "$((last_num + 1))"
        fi
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}/"
      register: candidate_number_result
      when: app_env in ['prep']
      tags: [skip_ansible_lint]

    - name: promoteBuildArtifact | Set release tag
      set_fact:
        candidate_suffix: "{{ (app_env in ['prep']) | ternary('_candidate' ~ candidate_number_result.stdout, '') }}"
        release_tag: "{{ tag_name }}{{ (app_env in ['prep']) | ternary('_candidate' ~ candidate_number_result.stdout, '') }}"

