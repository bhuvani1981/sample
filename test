- name: Commit and tag artifacts
  ansible.builtin.shell: |
    cd "{{ destination_directory }}/{{ github_repo_name }}"
    git add .
    if [ -n "$(git status --porcelain)" ]; then
      git commit --date="$(date -u +"%Y-%m-%dT%H:%M:%SZ")" -m "Promoting artifacts for {{ release_tag }}"
    fi
    if [ -z "$(git tag -l {{ release_tag }})" ]; then
      git tag -a {{ release_tag }} -m "Tagging artifacts with {{ release_tag }}"
    fi
    git push origin {{ target_branch }} --tags || (git fetch origin && git push origin {{ target_branch }} --tags --force)
  register: git_push
  failed_when: git_push.rc != 0 and 'tag already exists' not in git_push.stderr
  tags: skip_ansible_lint
