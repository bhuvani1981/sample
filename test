- name: promoteBuildArtifact | Ensure destination directory exists
  ansible.builtin.file:
    path: "{{ destination_directory }}/{{ github_repo_name }}"
    state: directory
    mode: 0750

- name: promoteBuildArtifact | Initialize git repo if not already initialized
  ansible.builtin.shell: git init
  args:
    chdir: "{{ destination_directory }}/{{ github_repo_name }}"
  when: not lookup('ansible.builtin.fileglob', destination_directory + '/' + github_repo_name + '/.git', errors='ignore')
  tags: [skip_ansible_lint]

- name: promoteBuildArtifact | Add origin remote if not already added
  ansible.builtin.shell: |
    git remote | grep -q origin || git remote add origin {{ destination_repo }}
  args:
    chdir: "{{ destination_directory }}/{{ github_repo_name }}"
  tags: [skip_ansible_lint]

- name: promoteBuildArtifact | Fetch and checkout target branch only
  ansible.builtin.shell: |
    git fetch --depth 1 origin {{ target_branch }}
    git checkout -B {{ target_branch }} FETCH_HEAD
  args:
    chdir: "{{ destination_directory }}/{{ github_repo_name }}"
  tags: [skip_ansible_lint]
