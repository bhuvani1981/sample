---
- name: Test | Clone build artifact repo
  hosts: "{{ var_hosts }}"
  become: true

  roles:
    - ansible-role-awscli
  vars:
    github_repo_name: "ars-build-artifacts"
    destination_directory: "/opt/tmp"
    build_user: "{{ lookup('ansible.builtin.env', 'BUILDUSER') }}"
    build_token: "{{ lookup('ansible.builtin.env', 'BUILDTOKEN') }}"
  pre_tasks:
    - name: promoteBuildArtifact | Include all files in vars
      include_vars:
        dir: ../vars/ars-defaults
        extensions:
          - yml

    - name: promoteBuildArtifact | Include playbook pre tasks
      include_tasks: ../tasks/playbookPreTasks.yml

  tasks:
    - name: promoteBuildArtifact | Reset no log if verbosity is high enough
      set_fact:
        no_log_value: false
      when: ansible_verbosity >= 3

    - name: promoteBuildArtifact | Set facts for checkout
      set_fact:
        destination_repo: "https://{{ build_user }}:{{ build_token }}@github.com/department-of-veterans-affairs/{{ github_repo_name }}"

    - name: promoteBuildArtifact | Set default facts
      set_fact:
        files_to_release: "{{ lookup('ansible.builtin.env', 'files_to_release') }}"
        tag_name: "{{ lookup('ansible.builtin.env', 'tag_name') }}"
        target_branch: "{{ lookup('ansible.builtin.env', 'target_branch') }}"

    - name: promoteBuildArtifact | Create dir to clone
      ansible.builtin.file:
        path: "{{ destination_directory }}"
        state: directory
        mode: 0750
 
    - name: promoteBuildArtifact | Ensure destination directory exists
      ansible.builtin.file:
        path: "{{ destination_directory }}/{{ github_repo_name }}"
        state: directory
        mode: '0750'

    - name: promoteBuildArtifact | Initialize and checkout target branch
      ansible.builtin.shell: |
        git init
        git remote add origin {{ destination_repo }} 2>/dev/null || true
        git fetch origin
        git checkout -f $(git rev-parse --verify origin/master 2>/dev/null || \
                          git rev-parse --verify origin/main 2>/dev/null || echo "HEAD")
        git branch -D {{ target_branch }} 2>/dev/null || true
        git checkout -b {{ target_branch }} || git checkout {{ target_branch }}
        git fetch --tags
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}"
      tags: skip_ansible_lint

    - name: promoteBuildArtifact | Set fake git tag list
      ansible.builtin.set_fact:
        git_tags:
          stdout_lines:
            - "{{ tag_name }}_candidate1"
            - "{{ tag_name }}_candidate2"

    - name: promoteBuildArtifact |  Get existing git tags
      ansible.builtin.command: git tag
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}"
      register: git_tags
      changed_when: false
      tags: skip_ansible_lint

    # Find matching candidate tags
    - name: promoteBuildArtifact | Set matching candidate tags
      set_fact:
        matching_tags: >-
          {{ git_tags.stdout_lines
          | select('search', tag_name + '_candidate\\d+')
          | list }}
      when: app_env == 'prep'

    - name: promoteBuildArtifact | Debug matching tags before extracting numbers
      debug:
        msg: "Matching tags: {{ matching_tags }}"
      when: app_env == 'prep'

    # Extract candidate numbers from tags like v2.4.3_candidatex
    - name: promoteBuildArtifact | Extract candidate numbers
      set_fact:
        candidate_numbers: >-
          {{
            matching_tags
           | map('regex_search', '_candidate(\\d+)', '\\1')
           | select('string')
           | map('int')
           | list
          }}
      when: 
        - app_env == 'prep'
        - matching_tags | length > 0

    - name: promoteBuildArtifact | Initialize candidate numbers
      set_fact:
        candidate_numbers: []
      when: 
        - app_env == 'prep'
        - candidate_numbers is not defined or candidate_numbers | length == 0

    # Determine next candidate number
    - name: promoteBuildArtifact | Set next candidate number
      set_fact:
        candidate_number: >-
          {{
            (candidate_numbers | max + 1)
            if (candidate_numbers is defined and candidate_numbers | length > 0)
            else 1
          }}
      when: app_env == 'prep'

    # Set release tag and suffix for prep
    - name: promoteBuildArtifact | Set release tag for prep environment
      set_fact:
        candidate_suffix: "{{'_candidate' ~ candidate_number if app_env == 'prep' else '' }}"
        release_tag: "{{ tag_name ~ ('_candidate' ~ candidate_number if app_env == 'prep' else '') }}"

    - name: promoteBuildArtifact | Checkout specific files files from develop to target branch
      ansible.builtin.shell: git checkout origin/develop -- {{ item.artifact_folder }}/{{ item.filename }}
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}/"
      loop: "{{ files_to_release }}"
      tags:
        - skip_ansible_lint

    - name: promoteBuildArtifact | Check for changes
      ansible.builtin.command: git status --porcelain
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}/"
      register: git_status
      changed_when: false
      tags:
        - skip_ansible_lint

    - name: promoteBuildArtifact | Commit and push promoted artifacts to target branch
      ansible.builtin.shell: |
        cd "{{ destination_directory }}/{{ github_repo_name }}"
        git add .
        git commit -m "ars_promoteBuildArtifacts-{{ release_tag }}"
        git tag -a {{ release_tag }} -m "Tagging artifacts with version {{ release_tag }}"
        git push origin {{ target_branch | default('master') }} --tags
      tags:
        - skip_ansible_lint
